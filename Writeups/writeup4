writeup 4

How could one add a differential expression analysis (DESeq2) step to the rnaseq_pipeline_array_depend.sh script such that DESeq2 runs only after all salmon jobs for all samples have completed?
One way that I would do this is by adding a dependency, so that after I run the salmon jobs, I would only run the deseq.sh file if the first job with salmon ran sucessfuly.

Example: sbatch --dependency=afterok:[JOB NUMBER FOR SALMON] deseq.sh

Alternatively, in the sbatch script, you could have the code in python or R that runs the deseq2 pipeline check if all the salmon files are present, and that it only will run deseq2 when that is the case.

Salmon Indexing Function:
// salmon index function

nextflow.enable.dsl=2

process SALMON_INDEX {

    tag "${transcriptome.simpleName}"

    publishDir "${params.outdir}/salmon_index", mode: 'copy', overwrite: true

    input:
        path transcriptome

    output:
        path "salmon_index"

    script:
    """
    salmon index -t ${transcriptome} -i salmon_index
    """
}

New workflow:

// RNA-seq QC → Trim Galore → Salmon + DESeq2 (from CSV samplesheet)
// Expect a CSV with columns: sample,read1,read2,condition
// No intermediate samples.csv is generated; DESeq2 infers quant.sf paths
// from --outdir/<sample>/salmon_outs/quant.sf
nextflow.enable.dsl=2

include { FASTQC } from './modules/qc/fastqc.nf'
include { TRIMGALORE } from './modules/qc/trimgalore.nf'
include { SALMON } from './modules/pseudoalign/salmon.nf'
include { DESEQ2 } from './modules/diffexp/deseq2.nf'

// -------------------- Channels --------------------
def samplesheet_ch = Channel
  .fromPath(params.samplesheet)
  .ifEmpty { error "Missing --samplesheet file: ${params.samplesheet}" }

samples_ch = samplesheet_ch.splitCsv(header:true).map { row ->
    tuple(row.sample.trim(), file(row.read1.trim(), absolute: true), file(row.read2.trim(), absolute:true), row.condition.trim())
}

// -------------------- Workflow --------------------

workflow {

    def data

    if( params.index ) {
        data = Channel.value( file(params.index) )
    }

    else if( params.transcriptome ) {
        data = SALMON_INDEX( file(params.transcriptome) )
    }
    else {
        log.error "no index file or transcriptome file"
    }

    FASTQC(samples_ch)
    trimmed_ch = TRIMGALORE(samples_ch)
    quant_ch   = SALMON(trimmed_ch, data)

    if( params.run_deseq ) {
        // Collect all Salmon outputs into a map {sample: quant_path}

        quant_paths_ch = quant_ch
            .map { sample, quant, cond -> "${sample},${quant}" }
            .collectFile(
                name: "quant_paths.csv",
                newLine: true,
                seed: "sample,quant_path"  // This adds the header as the first line
            )
        DESEQ2(quant_paths_ch, samplesheet_ch)
    }
}
workflow.onComplete {
    log.info "Pipeline finished. Results in: ${params.outdir}"
}

Terminal Output:

dagnyr@rice-02:~/bios270/BIOS270-AU25/Pipeline/rnaseq_nf$ module load apptainer
export NXF_SINGULARITY_CMD=apptainer
dagnyr@rice-02:~/bios270/BIOS270-AU25/Pipeline/rnaseq_nf$ nextflow run rnaseq.nf -params-file configs/params.yaml -c configs/nextflow.config -profile slurm -resume
Nextflow 25.10.2 is available - Please consider updating your version to it

 N E X T F L O W   ~  version 25.10.0

Launching `rnaseq.nf` [hungry_ochoa] DSL2 - revision: 1e0f51681d

[-        ] FASTQC     -
[-        ] TRIMGALORE -
executor >  slurm (12)
[e0/c988f7] FASTQC (SRR35560561)     | 0 of 6
[89/287b84] TRIMGALORE (SRR35560562) | 0 of 6
[-        ] SALMON                   -
[-        ] DESEQ2                   -
